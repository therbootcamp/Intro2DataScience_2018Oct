---
title: "Analysing"
subtitle: ""
author: "Introduction to Data Science with R<br/><a href='https://therbootcamp.github.io'>www.therbootcamp.com</a><br/><a href='https://twitter.com/therbootcamp'>@therbootcamp</a>"
date: "October 2018"
output:
  xaringan::moon_reader:
    css: ["default", "baselrbootcamp.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'

---

layout: true

<div class="my-footer"><span>
<a href="https://therbootcamp.github.io/"><font color="#7E7E7E">Introduction to Data Science with R, October 2018</font></a>
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
<a href="https://therbootcamp.github.io/"><font color="#7E7E7E">www.therbootcamp.com</font></a>
</span></div> 


---
  
```{r, eval = FALSE, echo = FALSE, message=FALSE}
# Code to knit slides
xaringan::inf_mr('_sessions/D1S2_Wrangling/Wrangling.Rmd')
baselers <- read_csv("https://raw.githubusercontent.com/therbootcamp/baselers/master/inst/extdata/baselers.txt")
```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(width=110)
options(digits = 4)
library(tidyverse)
library(baselers)
```

.pull-left4[

# Where you're at...

1 - Loaded packages (like `tidyverse`) with `library()`<br>

2 - Loaded external files as a new dataframe<br>

3 - Explore dataframes

4 - Calculate descriptive statistics on specific columns<br>

5 - Wrangle
    - Change column names
    - Add new columns
    - Filter
    - Join multiple dataframes
    - Change data format (wide v. long)

What's next?... <high>Analysing!</high>

]

.pull-right55[

```{r, eval = FALSE}
# Load libraries

library(tidyverse)

# Read external file

baslers <- read_csv(file = "data/baslers.txt")

# Explore data

View(baslers)   # Open in new window
dim(baslers)    # Show number of rows and columns
names(baslers)  # Show names

# Calculate descriptives on named colums

mean(baslers$age)   # What is the mean age?
table(baslers$sex)  # How many of each sex?

# Wrangle

baselers <- baselers %>%
  rename(age_y = age,          # New names
         salary = income) %>%
  mutate(age_m = age * 12) %>% # Create new column
  filter(sex == "male")        # filter rows...
```

]

---
.pull-left45[

# What do we mean by analysing??

<font size = 5><high>Create Groups</high></font>

Group data by certain variables

- For all males (`sex == "male"`)
- For all people in placebo conditoin (`condition == "placebo"`)

<font size = 5><high>Calculate summaries</high></font>

- Count number of cases
- Calculate mean of age (`mean(age)`)
- Calculate number of events (`sum(events)`)

]


.pull-right55[

Raw data (First 5 out of 1,000 rows)

```{r, echo = FALSE, eval = FALSE}
baselers %>%
  select(id, sex, education, income, happiness) %>%
  slice(1:5) %>%
knitr::kable()
```


| id|sex    |education         | income| happiness|
|--:|:------|:-----------------|------:|---------:|
|  1|male   |SEK_III           |   6300|         5|
|  2|male   |obligatory_school |  10900|         7|
|  3|female |SEK_III           |   5100|         7|
|  4|male   |SEK_III           |   4200|         7|
|  5|male   |SEK_III           |   4000|         5|

Aggregated data

```{r, echo = FALSE, eval = FALSE}
baselers %>%
  group_by(education, sex) %>%
  summarise(
    N = n(),
    Inc_mean = mean(income, na.rm = TRUE),
    Hap_mean = mean(happiness, na.rm = TRUE)
  ) %>%
  knitr::kable(digits = 1)
```

|education         |sex    |    N| Inc_mean| Hap_mean|
|:-----------------|:------|----:|--------:|--------:|
|apprenticeship    |female | 2168|   7663.0|      6.9|
|apprenticeship    |male   | 1818|   7388.9|      6.9|
|obligatory_school |female |  714|   7746.1|      6.9|
|obligatory_school |male   |  525|   7293.7|      6.8|
|SEK_II            |female |  469|   7385.0|      6.9|
|SEK_II            |male   |  272|   7254.7|      6.9|
|SEK_III           |female | 1649|   7666.1|      7.0|
|SEK_III           |male   | 2385|   7477.5|      6.9|

]

---


.pull-left45[

# `dplyr`

To calculate grouped summary analyses, we will use `dplyr` (again!)

<br>
```{r, echo= TRUE, eval = FALSE}
# Load packages individually

# install.packages('dplyr')

library(dplyr)

# Or just use the tidyverse!

# install.packages('tidyverse')

library(tidyverse)
```

]
 
.pull-right5[

<br><br><br>
```{r, echo = FALSE, out.width = "100%", fig.align = 'center'}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/dplyr_tidyr_hex.png")
```

]

---

# The Pipe!  <high>`%>%`</high>

.pull-left4[

`dplyr` makes extensive use of a new operator called the "Pipe" <high>`%>%`</high><br>

Read the "Pipe" <high>`%>%`</high> as "And Then..."

<br>

```{r, eval = FALSE, echo = TRUE}
# Start with data
data %>% # AND THEN...
  
DO_SOMETHING %>% # AND THEN...
  
DO_SOMETHING %>% # AND THEN...
  
DO_SOMETHING %>% # AND THEN...

```

]

.pull-right55[

<p align="center">
  <img src="https://upload.wikimedia.org/wikipedia/en/thumb/b/b9/MagrittePipe.jpg/300px-MagrittePipe.jpg" width = "450px"><br>
  This is not a pipe (but %>% is!)
</p>

]




---

# `summarise()`

.pull-left45[

Use `summarise()` to create new columns of <high>summary statistics</high>

```{r, echo = TRUE, eval = FALSE}
df %>%
  summarise(
    NAME = FUN(A),
    NAME = FUN(B)
  )
```

<u>Statistical functions</u>

| Function| asdf |
|:-------------|:---|
| `n()`| Number of cases in each group|
| `mean()`, `median()`, `max()`, `min()` `sum()` | Summary stats|
]

.pull-right5[

```{r}
# Calculate summary statistics
baselers %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    height_median = median(height),
    children_max = max(children)
  )
```

]



---

# Grouped Aggregation

<p align="center">
  <img src="https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/summarsed_data_diagram.png" height="470px">
</p> 


---

# `group_by()`, `summarise()`

.pull-left45[

Use `group_by()` to <high>group data</high> according to one or more columns

After grouping data, use `summarise()` to <high>calculate summary statistics</high> across groups of data

<u>Statistical functions</u>

| Function| asdf |
|:-------------|:---|
| `n()`| Number of cases in each group|
| `mean()`, `median()`, `max()`, `min()` `sum()` | Summary stats|
]

.pull-right5[

```{r}
# Group data by arm, and calculate many
#  summary statistics
baselers %>%
  group_by(sex) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    height_median = median(height),
    children_max = max(children)
  )
```

]


---

# Combine wrangling with analysing

.pull-left3[
<br><br>
You can easily combine multiple wrangling (filtering, slicing, renaming) and analysing operations at once!

Just use the pipe <high>%>%</high>



]

.pull-right65[

```{r}
baselers %>%
  filter(sex == "male" & children > 0) %>%  # male parents only
  group_by(confession) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_median = median(income, na.rm = TRUE)
  )
```

]

---
# Test!

.pull-left45[

Here is part of the baselers dataframe

```{r}
baselers %>%
  select(sex, fasnacht, age, income) %>%
  slice(1:5)
```


]


.pull-right5[

How do I calculate the following table?

```{r, echo = FALSE}
baselers %>%
  group_by(fasnacht) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_mean = mean(income, na.rm = TRUE)
  )
```

]


---
# Test!

.pull-left45[

Here is part of the baselers dataframe

```{r}
baselers %>%
  select(sex, fasnacht, age, income) %>%
  slice(1:5)
```


]


.pull-right5[

How do I calculate the following table?

```{r, echo = TRUE}
baselers %>%
  group_by(fasnacht) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_mean = mean(income, na.rm = TRUE)
  )
```

]


---
# Test!

.pull-left45[

Here is part of the baselers dataframe

```{r}
baselers %>%
  select(sex, fasnacht, age, income) %>%
  slice(1:5)
```


]


.pull-right5[

How do I calculate the following table?

```{r, echo = FALSE}
baselers %>%
  group_by(fasnacht, sex) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_mean = mean(income, na.rm = TRUE)
  )
```

]



---
# Test!

.pull-left45[

Here is part of the baselers dataframe

```{r}
baselers %>%
  select(sex, fasnacht, age, income) %>%
  slice(1:5)
```


]


.pull-right5[

How do I calculate the following table?

```{r, echo = TRUE}
baselers %>%
  group_by(fasnacht, sex) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_mean = mean(income, na.rm = TRUE)
  )
```

]


---
# Test!

.pull-left45[

Here is part of the baselers dataframe

```{r}
baselers %>%
  select(sex, fasnacht, age, income) %>%
  slice(1:5)
```


]


.pull-right5[

How do I calculate the following table?

```{r, echo = FALSE}
baselers %>%
  filter(sex == "male") %>%
  group_by(fasnacht, sex) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_mean = mean(income, na.rm = TRUE)
  )
```

]




---
# Test!

.pull-left45[

Here is part of the baselers dataframe

```{r}
baselers %>%
  select(sex, fasnacht, age, income) %>%
  slice(1:5)
```


]


.pull-right5[

How do I calculate the following table?

```{r, echo = TRUE}
baselers %>%
  filter(sex == "male") %>%
  group_by(fasnacht, sex) %>%
  summarise(
    N = n(),
    age_mean = mean(age),
    income_mean = mean(income, na.rm = TRUE)
  )
```

]

---

# Summary

.pull-left4[

1 - To calculate summary statistics across all rows, use `summarise()`

2 - To calculate grouped summary statistics, use `group_by()` and then `summarise()`

3 - "Keep the pipe <high>%>%</high> going" to continue working with your data frame.

4 - You can always do wrangling operations (`filter()`, `rename()`) before (or after!) aggregating

]

.pull-right55[

```{r, eval = FALSE}
# Assign result to baslers_agg

baslers_agg <- baselers %>% 
  
  # Change column names with rename()
  rename(age_years = age,
         weight_kg = weight)  %>% # PIPE!

  # Select specific rows with filter()
  filter(age_years < 40)  %>% # PIPE!
  
  # Create new columns witb mutate()
  mutate(debt_ratio = debt / income)  %>% # PIPE!
  
  # Group data with group_by()
  group_by(sex) %>% # PIPE!
  
  # Calculate summary statistics with summarise()
  summarise(income_mean = mean(income),
            debt_mean = mean(debt),
            dr_mean = mean(dr))
```

]

---

# Practical

<p>
  <font size=6>
    <a href="https://therbootcamp.github.io/Intro2DataScience_2018Oct/_sessions/Analysing/Analysing_practical.html"><b>Link to practical<b></a>
  </font>
</p>
