---
title: "Analysing"
author: "Introduction to Data Science with R, October 2018<br/><a href='https://therbootcamp.github.io'>www.therbootcamp.com</a><br/><a href='https://twitter.com/therbootcamp'>@therbootcamp</a>"
output:
  html_document:
    css: practical.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE)

options(digits = 3)
```

<figure>
<center>
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Seattle_-_Craftsman_revival_houses.jpg/300px-Seattle_-_Craftsman_revival_houses.jpg" alt="Trulli" style="width:50%">
  <figcaption>https://en.wikipedia.org/wiki/Seattle_box</figcaption>
</figure>

## {.tabset}

### Overview

In this practical you'll practice grouping and analysing data with the `dplyr` and `tidyr` packages (part of the `tidyverse collection of packages).

By the end of this practical you will know how to:

1. Group data and calculate summary statistics

### Datasets

```{r, eval = TRUE, message = FALSE}
library(tidyverse)
kc_house <- read_csv("https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data//baselrbootcamp_data/kc_house.csv")
```

|File | Rows | Columns | Description |
|:----|:-----|:------|:-----------------------------------------|
|[kc_house.csv](https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data//baselrbootcamp_data/kc_house.csv) | 21613 | 21|House sale prices for King County between May 2014 and May 2015. |

### Packages

|Package| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|

### Glossary

| Function| Package | Description |
|:---|:------|:---------------------------------------------|
|     `rename()`|`dplyr`|    Rename columns| 
|     `select()`|`dplyr`|    Select columns based on name or index| 
|     `filter()`|`dplyr`|    Select rows based on some logical criteria| 
|     `arrange()`|`dplyr`|    Sort rows| 
|     `mutate()`|`dplyr`|    Add new columns|
|     `case_when()`|`dplyr`|    Recode values of a column| 
|     `group_by(), summarise()`|`dplyr`|   Group data and then calculate summary statistics|
|     `left_join()`|`dplyr`|   Combine multiple data sets using a key column|
|     `spread()`|`tidyr`|    Convert long data to wide format - from rows to columns| 
|     `gather()`|`tidyr`|    Convert wide data to long format - from columns to rows|

### Cheatsheet

<figure>
<center>
<a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">
  <img src="https://image.slidesharecdn.com/data-wrangling-cheatsheet-160705210122/95/data-wrangling-with-dplyr-and-tidyr-cheat-sheet-1-638.jpg?cb=1467752577" alt="Trulli" style="width:70%">
  <figcaption>https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf</figcaption></a>
</figure>

### Examples

```{r, eval = FALSE, echo = TRUE}

# Wrangling with dplyr and tidyr ---------------------------

library(tidyverse)    # Load tidyverse for dplyr and tidyr

# Load baselers data
baselers <- read_csv("1_Data/baselers.txt")

# No grouping variables

bas <- baselers %>%
  summarise(
    age_mean = mean(age, na.rm = TRUE),
    income_median = median(income, na.rm = TRUE),
    N = n()
  )

# One grouping variable
bas_sex <- baselers %>%
  group_by(sex) %>%
  summarise(
    age_mean = mean(age, na.rm = TRUE),
    income_median = median(income, na.rm = TRUE),
    N = n()
  )

bas_sex

# Two grouping variables
bas_sex_ed <- baselers %>%
  group_by(sex, education) %>%
  summarise(
    age_mean = mean(age, na.rm = TRUE),
    income_median = median(income, na.rm = TRUE),
    N = n()
  )

# Advanced scoping

# Calculate mean of ALL numeric variables
baselers %>%
  group_by(sex, education) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
```

# Tasks

## A - Setup

1. Open your `baselrbootcamp` R project. It should already have the folders `1_Data` and `2_Code`. Make sure that the data files listed in the `Datasets` section above are in your `1_Data` folder

```{r}
# Done!
```

2. Open a new R script. At the top of the script, using comments, write your name and the date. Save it as a new file called `analysing_practical.R` in the `2_Code` folder.  
3. Using `library()` load the set of packages for this practical listed in the packages section above.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
library(tidyverse)
```

3. For this practical, we'll use the `kc_house.csv` data. This dataset contains house sale prices for King County, Washington. It includes homes sold between May 2014 and May 2015. Using the following template, load the data into R and store it as a new object called `kc_house`.

```{r, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
kc_house <- read_csv(file = "XX")
```

```{r}
kc_house <- read_csv(file = "1_Data/kc_house.csv")
```

4. Using `print()`, `summary()`, and `head()`, explore the data to make sure it was loaded correctly.

```{r}
kc_house
summary(kc_house)
head(kc_house)
```


### A - Recap

1. Print the names of the `kc_house` data with `names()`

```{r}
names(kc_house)
```

2. Change the following column names using `rename()`

|New Name | Old Name|
|:----|:----|
|living_sqft|sqft_living |
|lot_sqft|sqft_lot |
|above_sqft|sqft_above |
|basement_sqft|sqft_basement |
|built_yr|yr_built |
|renovated_yr|yr_renovated|

```{r, echo = TRUE, eval = FALSE}
kc_house <- kc_house %>%
  rename(NEW = OLD,
         NEW = OLD,
         NEW = OLD)
```

```{r, echo = FALSE, eval = TRUE}
kc_house <- kc_house %>%
  rename(living_sqft = sqft_living,
         lot_sqft = sqft_lot,
         above_sqft = sqft_above,
         basement_sqft = sqft_basement,
         built_yr = yr_built,
         renovated_yr = yr_renovated)
```

3. Create new column(s) `living_sqm`, `lot_sqm`, `above_sqm` and `basement_sqm` which show  the respective room sizes in square meters rather than square feet (Hint: Multiply each by 0.093)

```{r, echo = TRUE, eval = FALSE}
kc_house <- kc_house %>%
  mutate(living_sqm = XXX * XXX,
         lot_sqm = XXX * XXX,
         XXX = XXX,
         XXX = XXX)
```

```{r, eval = TRUE}
kc_house <- kc_house %>%
  mutate(living_sqm = living_sqft * 0.093,
         lot_sqm = lot_sqft * 0.093,
         above_sqm = above_sqft * 0.093,
          basement_sqm  = basement_sqft * 0.093)
```

4. Add a new variable to the dataframe called `mansion` which is "Yes" when the *sum* of the house's living, above, and basement space is above 750 square meters

```{r, echo = TRUE, eval = FALSE}
kc_house <- kc_house %>%
                mutate(XXX = case_when(
                              XXX + XXX + XXX > XXX ~ "XXX",
                              XXXX + XXX + XXX <= XXX ~ "XXX"))
```

```{r, eval = TRUE}
kc_house <- kc_house %>%
                mutate(mansion = case_when(
                              living_sqm + above_sqm +  basement_sqm > 750 ~ "Yes",
                              living_sqm +above_sqm + basement_sqm <= 750 ~ "No"))
```



### H - Calculate grouped statistics with `group_by()` and `summarise()`

1. Using the base-R `df$col` notation, calculate the mean price of all houses.

```{r, echo = TRUE, eval = FALSE}
mean(XXX$XXX)
```

```{r}
mean(kc_house$price)
```

2. Now, do the same using `summarise()` using the following template. Do you get the same answer? What is different about the output from `summarise()` versus using the dollar sign?

```{r, echo = TRUE, eval = FALSE}
kc_house %>%
  summarise(
    price_mean = mean(XXX)
  )
```

```{r}
kc_house %>%
  summarise(
    price_mean = mean(price)
  )
```

3. What is the *median* price of all houses? Use the `median()` function!

4. What is the highest number of living square meters in the dataset? Use the `max()` function!

5. How many mansions are there? To do this, use `group_by()` to group the dataset by the `mansions` column, then use the `n()` function to count the number of cases:

```{r, echo = TRUE, eval = FALSE}
kc_house %>%
  group_by(XXX) %>%
  summarise(XXX = n())
```

```{r}
kc_house %>%
  group_by(mansion) %>%
  summarise(N = n())
```

6. What is the mean selling price of mansions versus non-mansions? To do this, just add another argument to your `summarise()` function!

```{r, echo = TRUE, eval = FALSE}
kc_house %>%
  group_by(mansion) %>%
  summarise(N = n(),
            XXX = XXX(XXX))
```

```{r}
kc_house %>%
  group_by(mansion) %>%
  summarise(N = n(),
            price_mean = mean(price))
```

7. Using `group_by()` and `summarise()`, create a dataframe showing the same results as the following table

```{r, echo = FALSE, eval = TRUE, results = 'asis'}
kc_house %>%
  group_by(mansion) %>%
  summarise(N = n(),
            price_min = min(price),
            price_mean = mean(price),
            price_median = median(price),
            price_max = max(price)) %>%
  knitr::kable()
```






## Additional Resources

- See [https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html](https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html) for the full dplyr vignette with lots of wrangling tips and tricks.


